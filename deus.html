<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deus | Chrono-Spatial Simulator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Three.js for the Globe -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@200;300;400;500;600&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(20, 20, 25, 0.6);
            --neon-blue: #00f0ff;
            --neon-purple: #bd00ff;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #050505;
            color: white;
            overflow: hidden; /* Prevent scrolling, 3D canvas covers all */
        }

        .font-display {
            font-family: 'Space Grotesk', sans-serif;
        }

        /* Apple-esque Glassmorphism */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        /* Animations */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px rgba(0, 240, 255, 0.2); }
            50% { box-shadow: 0 0 20px rgba(0, 240, 255, 0.5); }
        }

        .animate-scanline {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: rgba(0, 240, 255, 0.3);
            opacity: 0.6;
            animation: scanline 2s linear infinite;
            pointer-events: none;
            z-index: 50;
        }

        @keyframes scanline {
            0% { top: -5%; }
            100% { top: 105%; }
        }

        /* Input Styling */
        input[type="range"] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 10px white;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        .hidden-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        #canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .text-glow {
            text-shadow: 0 0 10px rgba(255,255,255,0.3);
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-between relative selection:bg-cyan-500 selection:text-black">

    <!-- 3D Globe Background -->
    <div id="canvas-container"></div>

    <!-- UI Overlay: Header -->
    <header class="z-10 w-full max-w-7xl mx-auto p-6 flex justify-between items-start pointer-events-none">
        <div class="pointer-events-auto">
            <h1 class="font-display text-4xl font-bold tracking-tighter text-white">DEUS <span class="text-cyan-400 text-sm align-top tracking-widest font-sans opacity-80">v3.0</span></h1>
            <p class="text-xs text-gray-400 tracking-widest uppercase mt-1">Chrono-Spatial Simulator</p>
        </div>
        
        <div class="glass-panel rounded-full px-4 py-2 flex items-center gap-3 pointer-events-auto transition-transform hover:scale-105 cursor-default">
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            <span class="text-xs font-medium text-gray-300">System Online</span>
        </div>
    </header>

    <!-- Main Result Modal (Initially Hidden) -->
    <div id="result-modal" class="fixed inset-0 z-40 bg-black/80 backdrop-blur-md hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-500">
        <div class="glass-panel w-full max-w-4xl h-[85vh] rounded-3xl overflow-hidden flex flex-col md:flex-row shadow-2xl border border-white/10 relative transform scale-95 transition-transform duration-500" id="result-content">
            
            <!-- Close Button -->
            <button onclick="closeModal()" class="absolute top-4 right-4 z-50 p-2 bg-black/50 hover:bg-white/20 rounded-full transition text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>

            <!-- Image Side -->
            <div class="w-full md:w-1/2 h-1/2 md:h-full relative bg-black">
                <div id="image-loader" class="absolute inset-0 flex flex-col items-center justify-center z-10">
                    <div class="w-12 h-12 border-4 border-cyan-500 border-t-transparent rounded-full animate-spin mb-4"></div>
                    <span class="text-cyan-400 text-xs tracking-widest animate-pulse">RENDERING TIMELINE...</span>
                </div>
                <img id="generated-image" class="w-full h-full object-cover opacity-0 transition-opacity duration-1000" alt="Generated Timeline">
                <div class="absolute bottom-0 left-0 w-full p-6 bg-gradient-to-t from-black via-black/80 to-transparent">
                    <div class="font-display text-2xl font-bold text-white mb-1" id="result-location"></div>
                    <div class="text-cyan-400 font-mono text-sm" id="result-year"></div>
                </div>
            </div>

            <!-- Text Side -->
            <div class="w-full md:w-1/2 h-1/2 md:h-full p-8 md:p-12 overflow-y-auto relative bg-gradient-to-br from-gray-900 to-black">
                <div class="animate-scanline"></div>
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-6">Deus Log Entry</h3>
                <div id="text-loader" class="space-y-3 animate-pulse">
                    <div class="h-4 bg-white/10 rounded w-3/4"></div>
                    <div class="h-4 bg-white/10 rounded w-full"></div>
                    <div class="h-4 bg-white/10 rounded w-5/6"></div>
                </div>
                <div id="generated-text" class="prose prose-invert prose-lg leading-relaxed text-gray-200 font-light hidden">
                    <!-- Content goes here -->
                </div>
                
                <div class="mt-8 pt-8 border-t border-white/10 flex justify-between items-center text-xs text-gray-500 font-mono">
                    <span>GEN: GEMINI-3-PROT</span>
                    <span>STATUS: STABLE</span>
                </div>
            </div>
        </div>
    </div>

    <!-- UI Overlay: Controls -->
    <footer class="z-20 w-full max-w-4xl mx-auto p-6 mb-4 pointer-events-none">
        <div class="glass-panel rounded-3xl p-6 pointer-events-auto relative overflow-hidden group">
            
            <!-- Randomizer Button (Floating Top Right) -->
            <button onclick="randomize()" class="absolute top-6 right-6 p-2 text-cyan-400 hover:text-white hover:bg-cyan-500/20 rounded-full transition-all" title="Random Jump">
                <i data-lucide="shuffle" class="w-5 h-5"></i>
            </button>

            <div class="flex flex-col gap-6">
                <!-- Location Display & Edit -->
                <div class="flex flex-col">
                    <label class="text-xs text-gray-400 uppercase tracking-widest mb-2 font-semibold">Target Coordinates</label>
                    <div class="flex items-center gap-3">
                        <i data-lucide="map-pin" class="w-5 h-5 text-cyan-400"></i>
                        <input type="text" id="location-input" 
                            class="bg-transparent text-2xl md:text-3xl font-display font-bold text-white w-full focus:outline-none placeholder-gray-600 border-b border-transparent focus:border-cyan-500/50 transition-colors"
                            placeholder="Select on Globe or Type..." value="New York City">
                    </div>
                    <div class="text-xs font-mono text-gray-500 mt-1 pl-8" id="lat-long-display">40.7128° N, 74.0060° W</div>
                </div>

                <!-- Timeline Slider -->
                <div class="flex flex-col">
                    <div class="flex justify-between items-end mb-2">
                        <label class="text-xs text-gray-400 uppercase tracking-widest font-semibold">Temporal Target</label>
                        <input type="number" id="year-input" value="2025" 
                            class="bg-transparent text-right font-display text-3xl font-bold text-cyan-400 w-32 focus:outline-none border-b border-transparent focus:border-cyan-500/50"
                            min="-5000" max="3000">
                    </div>
                    <input type="range" id="year-slider" min="-2000" max="3000" value="2025" step="10" class="w-full h-2 bg-white/10 rounded-lg appearance-none cursor-pointer">
                    <div class="flex justify-between text-[10px] text-gray-500 font-mono mt-2">
                        <span>2000 BC</span>
                        <span>0 AD</span>
                        <span>1000 AD</span>
                        <span>2025 AD</span>
                        <span>3000 AD</span>
                    </div>
                </div>

                <!-- Engage Button -->
                <button onclick="engage()" id="engage-btn" class="w-full bg-white text-black font-bold text-lg py-4 rounded-xl hover:bg-cyan-400 hover:scale-[1.01] transition-all duration-300 shadow-[0_0_20px_rgba(255,255,255,0.2)] hover:shadow-[0_0_30px_rgba(0,240,255,0.4)] flex items-center justify-center gap-2">
                    <i data-lucide="zap" class="w-5 h-5 fill-current"></i>
                    INITIATE SEQUENCE
                </button>
            </div>
        </div>
    </footer>

    <script>
        // Initialize Lucide Icons
        lucide.createIcons();

        // Global State
        const state = {
            lat: 40.7128,
            lng: -74.0060,
            locationName: "New York City",
            year: 2025
        };

        // Notable Events Database (The Randomizer)
        const timelineEvents = [
            { year: -2560, name: "Giza Necropolis", lat: 29.9792, lng: 31.1342 },
            { year: -44, name: "Roman Senate", lat: 41.8902, lng: 12.4922 },
            { year: 1492, name: "San Salvador Island", lat: 24.1235, lng: -74.4717 },
            { year: 1889, name: "Paris World Fair", lat: 48.8584, lng: 2.2945 },
            { year: 1969, name: "Kennedy Space Center", lat: 28.5729, lng: -80.6490 },
            { year: 2077, name: "Neo-Tokyo", lat: 35.6762, lng: 139.6503 },
            { year: 1912, name: "North Atlantic Ocean", lat: 41.7325, lng: -49.9469 }, // Titanic
            { year: 1776, name: "Philadelphia", lat: 39.9526, lng: -75.1652 },
            { year: -399, name: "Athens", lat: 37.9838, lng: 23.7275 },
            { year: 2150, name: "Mars Colony Alpha", lat: 36.1699, lng: -115.1398 } // Vegas as proxy
        ];

        // --- THREE.JS GLOBE SETUP ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();
        // Add subtle fog for depth
        scene.fog = new THREE.FogExp2(0x000000, 0.02);

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 18; // Start zoomed out slightly

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        // Lights
        const ambientLight = new THREE.AmbientLight(0x333333);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.position.set(5, 3, 5);
        scene.add(directionalLight);
        
        // Add a blue rim light for the "Deus" aesthetic
        const pointLight = new THREE.PointLight(0x00f0ff, 1.5, 50);
        pointLight.position.set(-10, 10, 10);
        scene.add(pointLight);

        // Earth Group (Holds Sphere + Clouds + Atmosphere)
        const earthGroup = new THREE.Group();
        scene.add(earthGroup);

        // 1. The Sphere (Earth)
        // Using a high-quality map texture from a reliable source. 
        // If it fails to load, it falls back to the color.
        const earthGeometry = new THREE.SphereGeometry(5, 64, 64);
        const textureLoader = new THREE.TextureLoader();
        
        // NASA Blue Marble texture or similar
        const earthTexture = textureLoader.load('https://upload.wikimedia.org/wikipedia/commons/2/22/Earth_Western_Hemisphere_transparent_background.png'); 
        // Note: For a true globe we need a equirectangular projection. 
        // Using a generic reliable earth map texture:
        const mapTexture = textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_atmos_2048.jpg');
        const specularTexture = textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_specular_2048.jpg');
        const normalTexture = textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_normal_2048.jpg');

        const earthMaterial = new THREE.MeshPhongMaterial({
            map: mapTexture,
            specular: 0x333333,
            specularMap: specularTexture,
            normalMap: normalTexture,
            shininess: 15
        });
        const earth = new THREE.Mesh(earthGeometry, earthMaterial);
        earthGroup.add(earth);

        // 2. Atmosphere Glow
        const atmosGeometry = new THREE.SphereGeometry(5.2, 64, 64);
        const atmosMaterial = new THREE.MeshPhongMaterial({
            color: 0x00f0ff,
            transparent: true,
            opacity: 0.1,
            side: THREE.BackSide,
            blending: THREE.AdditiveBlending,
        });
        const atmosphere = new THREE.Mesh(atmosGeometry, atmosMaterial);
        scene.add(atmosphere);

        // 3. Starfield Background
        const starsGeometry = new THREE.BufferGeometry();
        const starsCount = 2000;
        const posArray = new Float32Array(starsCount * 3);
        for(let i = 0; i < starsCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 100; // Spread stars
        }
        starsGeometry.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const starsMaterial = new THREE.PointsMaterial({
            size: 0.05,
            color: 0xffffff,
            transparent: true,
            opacity: 0.8,
        });
        const starMesh = new THREE.Points(starsGeometry, starsMaterial);
        scene.add(starMesh);

        // Marker for selected location
        const markerGeometry = new THREE.SphereGeometry(0.1, 16, 16);
        const markerMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
        const marker = new THREE.Mesh(markerGeometry, markerMaterial);
        earthGroup.add(marker);
        
        // Helper to position marker
        function updateMarker(lat, lng) {
            const phi = (90 - lat) * (Math.PI / 180);
            const theta = (lng + 180) * (Math.PI / 180);
            const r = 5.05; // Slightly above surface

            const x = -(r * Math.sin(phi) * Math.cos(theta));
            const z = (r * Math.sin(phi) * Math.sin(theta));
            const y = (r * Math.cos(phi));

            marker.position.set(x, y, z);
            
            // Rotate earth to face the user roughly
            // For smooth rotation we typically tween, but for this simple version:
            // We'll let the user rotate the earth manually mostly.
        }
        
        // Initial Marker
        updateMarker(state.lat, state.lng);

        // Interaction (Raycaster)
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let isDragging = false;
        let previousMousePosition = { x: 0, y: 0 };

        // Handle Window Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Mouse Events for Rotation & Clicking
        document.addEventListener('mousedown', (e) => {
            // Check if clicking on UI
            if (e.target.closest('header') || e.target.closest('footer') || e.target.closest('#result-modal')) return;
            isDragging = true;
            previousMousePosition = { x: e.clientX, y: e.clientY };
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const deltaMove = {
                    x: e.clientX - previousMousePosition.x,
                    y: e.clientY - previousMousePosition.y
                };

                const rotateSpeed = 0.005;
                earthGroup.rotation.y += deltaMove.x * rotateSpeed;
                earthGroup.rotation.x += deltaMove.y * rotateSpeed;

                previousMousePosition = { x: e.clientX, y: e.clientY };
            }
        });

        // Double Click to Select Location
        document.addEventListener('dblclick', (event) => {
             // Check if clicking on UI
             if (event.target.closest('header') || event.target.closest('footer') || event.target.closest('#result-modal')) return;

            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects([earth]);

            if (intersects.length > 0) {
                const point = intersects[0].point;
                // Convert Cartesian to Lat/Lng
                // x = -r sin(phi) cos(theta)
                // z = r sin(phi) sin(theta)
                // y = r cos(phi)
                
                // Be careful with local vs world space if group is rotated.
                // To simplify, we calculate based on the group's rotation inverse or just assume user aligns.
                // Ideally, we transform point to earth's local space.
                const localPoint = earth.worldToLocal(point.clone());
                
                const r = 5;
                const phi = Math.acos(localPoint.y / r);
                const theta = Math.atan2(localPoint.z, -localPoint.x); // Note the -x

                let lat = 90 - (phi * 180 / Math.PI);
                let lng = (theta * 180 / Math.PI) - 180;
                
                // Fix longitude offset
                // Just simpler approach:
                // lat = asin(y/r)
                // lng = atan2(z, x)
                // We will use an approximation for this demo or just visual feedback.
                
                // Update State (Approximate)
                state.lat = lat;
                state.lng = lng;
                state.locationName = "Custom Coordinates";
                
                // Update UI
                document.getElementById('location-input').value = `${lat.toFixed(2)}, ${lng.toFixed(2)}`;
                document.getElementById('lat-long-display').innerText = `${lat.toFixed(4)}° N, ${lng.toFixed(4)}° W`;
                
                updateMarker(lat, lng);
            }
        });

        // Animation Loop
        function animate() {
            requestAnimationFrame(animate);
            
            // Slow rotation idle
            if (!isDragging) {
                earthGroup.rotation.y += 0.0005;
            }
            
            // Atmosphere follows camera slightly or pulses
            atmosphere.rotation.copy(earthGroup.rotation);

            renderer.render(scene, camera);
        }
        animate();


        // --- UI LOGIC ---

        const yearSlider = document.getElementById('year-slider');
        const yearInput = document.getElementById('year-input');
        const locInput = document.getElementById('location-input');

        // Sync slider and input
        yearSlider.addEventListener('input', (e) => {
            state.year = e.target.value;
            yearInput.value = state.year;
        });

        yearInput.addEventListener('change', (e) => {
            state.year = e.target.value;
            yearSlider.value = state.year;
        });

        locInput.addEventListener('change', (e) => {
            state.locationName = e.target.value;
        });

        function randomize() {
            const randomEvent = timelineEvents[Math.floor(Math.random() * timelineEvents.length)];
            
            // Update State
            state.lat = randomEvent.lat;
            state.lng = randomEvent.lng;
            state.year = randomEvent.year;
            state.locationName = randomEvent.name;

            // Update UI
            yearInput.value = state.year;
            yearSlider.value = state.year;
            locInput.value = state.name;
            document.getElementById('lat-long-display').innerText = `${state.lat}° N, ${state.lng}° W`;
            
            // Update 3D
            updateMarker(state.lat, state.lng);
            
            // Flash Effect
            const btn = document.querySelector('button[title="Random Jump"]');
            btn.classList.add('text-white', 'scale-125');
            setTimeout(() => btn.classList.remove('text-white', 'scale-125'), 200);
        }

        // --- GEMINI API INTEGRATION ---
        
        async function engage() {
            const modal = document.getElementById('result-modal');
            const resultContent = document.getElementById('result-content');
            const engageBtn = document.getElementById('engage-btn');
            
            // Loading State
            engageBtn.innerHTML = `<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> CALCULATING...`;
            engageBtn.disabled = true;

            // Prepare Prompts
            const userPrompt = `Location: ${state.locationName}. Time: ${state.year}.`;
            const systemPrompt = `You are Deus, an advanced chronospatial simulator. The user provides a location and a time. You must generate a vivid, sensory-rich, second-person narrative description of arriving at that specific place and time. Focus on the atmosphere, the smells, the sounds, and the visual details immediately surrounding the traveler. Keep it immersive and between 150-200 words. Format nicely with paragraphs.`;
            
            const imagePrompt = `Cinematic, hyper-realistic wide shot of ${state.locationName} in the year ${state.year}. Atmosphere, detailed historical architecture or futuristic landscape depending on year. 8k resolution, highly detailed, photorealistic.`;

            try {
                // 1. Show Modal immediately with Loaders
                modal.classList.remove('hidden');
                // Trigger reflow
                void modal.offsetWidth; 
                modal.classList.remove('opacity-0');
                resultContent.classList.remove('scale-95');
                
                // Reset Modal Content
                document.getElementById('generated-text').classList.add('hidden');
                document.getElementById('text-loader').classList.remove('hidden');
                document.getElementById('generated-image').classList.add('opacity-0');
                document.getElementById('image-loader').classList.remove('hidden');
                document.getElementById('result-location').innerText = state.locationName;
                document.getElementById('result-year').innerText = state.year < 0 ? `${Math.abs(state.year)} BC` : `${state.year} AD`;

                const apiKey = ""; // API Key injected by environment
                
                // 2. Fetch Text (Gemini 2.5)
                const textResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userPrompt }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                const textData = await textResponse.json();
                const generatedText = textData.candidates?.[0]?.content?.parts?.[0]?.text || "Temporal interference detected. Data corrupted.";

                // Display Text
                const textContainer = document.getElementById('generated-text');
                textContainer.innerHTML = generatedText.replace(/\n/g, '<br><br>'); // Simple formatting
                document.getElementById('text-loader').classList.add('hidden');
                textContainer.classList.remove('hidden');


                // 3. Generate Image (Imagen 4.0 - mapped from user request for 'Deus v3')
                // Using imagen-4.0-generate-001 as required by environment for generation
                const imageResponse = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        instances: [{ prompt: imagePrompt }],
                        parameters: { sampleCount: 1 }
                    })
                });

                const imageData = await imageResponse.json();
                // Handle potential different response structures or errors
                let imageBase64 = "";
                if (imageData.predictions && imageData.predictions[0] && imageData.predictions[0].bytesBase64Encoded) {
                    imageBase64 = imageData.predictions[0].bytesBase64Encoded;
                }

                if (imageBase64) {
                    const imgEl = document.getElementById('generated-image');
                    imgEl.src = `data:image/png;base64,${imageBase64}`;
                    imgEl.onload = () => {
                        document.getElementById('image-loader').classList.add('hidden');
                        imgEl.classList.remove('opacity-0');
                    };
                } else {
                    document.getElementById('image-loader').innerHTML = "<span class='text-red-500'>VISUAL SENSOR OFFLINE</span>";
                }

            } catch (error) {
                console.error(error);
                document.getElementById('generated-text').innerText = "CRITICAL ERROR: Chrono-displacement failed. Check console log.";
                document.getElementById('generated-text').classList.remove('hidden');
                document.getElementById('text-loader').classList.add('hidden');
            } finally {
                // Reset Button
                engageBtn.innerHTML = `<i data-lucide="zap" class="w-5 h-5 fill-current"></i> INITIATE SEQUENCE`;
                engageBtn.disabled = false;
            }
        }

        function closeModal() {
            const modal = document.getElementById('result-modal');
            const resultContent = document.getElementById('result-content');
            
            modal.classList.add('opacity-0');
            resultContent.classList.add('scale-95');
            
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 500);
        }

        // Close modal on outside click
        document.getElementById('result-modal').addEventListener('click', (e) => {
            if (e.target.id === 'result-modal') closeModal();
        });

    </script>
</body>
</html>
